{% extends "./plantilla.html" %}
{% load static %}
{% block contenido %}
<link rel="stylesheet" href="{% static 'plantilla_cliente/css/estilos.css' %}">
<link rel="stylesheet" href="{% static 'plantilla_cliente/css/style.css' %}">

{% include "barra_checkout.html" with paso_actual='datos' %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .resumen-pedido-card {
        font-size: 14px;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #ccc;
    }

    .resumen-pedido-card img {
        border-radius: 5px;
    }

    .form-control {
        font-size: 14px;
        padding: 6px 10px;
    }

    .form-label {
        font-weight: bold;
        font-size: 14px;
    }

    .btn-sm-custom {
        font-size: 14px;
        padding: 6px 16px;
        border-radius: 6px;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
    }
    
    .counter {
        font-size: 11px;
        color: #6c757d;
        text-align: right;
        margin-top: 2px;
    }
    
    .counter.invalid {
        color: #dc3545;
    }
</style>

<body class="bg-light">

<div class="container mt-5">
    <div class="row">
        <!-- Mensajes de error -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mb-4">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Formulario de Datos del Pedido -->
        <div class="col-md-7">
            <h4 class="fw-bold mb-4">DATOS DEL PEDIDO</h4>
            <form method="POST" action="{% url 'datosPedido' %}" id="formulario-pago">
                {% csrf_token %}
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Nombre del cliente</label>
                        <input type="text" class="form-control" placeholder="Nombre" name="nombre" 
                               value="{{ datos_cliente.nombre|default:"" }}" 
                               maxlength="50"
                               required>
                        <div class="counter" id="nombre-counter">0/50</div>
                        <div class="error-message" id="nombre-error">Solo se permiten letras y espacios (máx. 50 caracteres)</div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Tipo de documento</label>
                        <select id="tipo_documento" name="tipo_documento" class="form-control" required>
                            <option value="">Seleccione</option>
                            <option value="cedula" {% if datos_cliente.tipo_documento == "cedula" %}selected{% endif %}>Cédula</option>
                            <option value="ruc" {% if datos_cliente.tipo_documento == "ruc" %}selected{% endif %}>RUC</option>
                            <option value="pasaporte" {% if datos_cliente.tipo_documento == "pasaporte" %}selected{% endif %}>Pasaporte</option>
                        </select>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Número de documento</label>
                        <input id="numero_documento" type="text" name="numero_documento" class="form-control"
                            value="{{ datos_cliente.numero_documento|default:"" }}"
                            required>
                        <div class="counter" id="documento-counter"></div>
                        <div class="error-message" id="documento-error"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" placeholder="correo@ejemplo.com" 
                               name="email" value="{{ datos_cliente.email|default:request.user.email }}" 
                               maxlength="100" required>
                        <div class="counter" id="email-counter">0/100</div>
                        <div class="error-message" id="email-error">Ingrese un correo electrónico válido</div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" placeholder="Dirección" name="direccion" 
                               value="{{ datos_cliente.direccion|default:"" }}" 
                               maxlength="200" required>
                        <div class="counter" id="direccion-counter">0/200</div>
                    </div>
                    <div class="col">
                        <label class="form-label">Ciudad</label>
                        <input type="text" class="form-control" placeholder="Ciudad" name="ciudad" 
                               value="{{ datos_cliente.ciudad|default:"" }}" 
                               maxlength="50" required>
                        <div class="counter" id="ciudad-counter">0/50</div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" placeholder="Ej: 0987654321" name="telefono" 
                            value="{{ datos_cliente.telefono|default:request.user.cel_user }}" 
                            maxlength="10" required>
                        <div class="counter" id="telefono-counter">0/10</div>
                        <div class="error-message" id="telefono-error">Ingrese un número de teléfono ecuatoriano válido (10 dígitos)</div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{% url 'carrito' %}" class="btn btn-info text-white btn-sm-custom rounded-pill">← Atrás</a>
                    <button type="submit" class="btn btn-primary btn-sm-custom rounded-pill">Siguiente →</button>
                </div>
            </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="col-md-5 col-lg-4 mt-4 mt-md-0">
            <div class="resumen-pedido-card p-3 shadow-sm rounded">
                <h5 class="text-center mb-3 fw-bold">Resumen del Pedido</h5>

                {% for item in cart_items %}
                <div class="d-flex mb-2 align-items-center">
                    <!-- Imagen -->
                    <div style="width: 45px; height: 45px;">
                        <img src="{{ item.product.img_prod.url }}" class="img-thumbnail" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>

                    <!-- Nombre y Cantidad -->
                    <div class="flex-grow-1 mx-2" style="font-size: 14px;">
                        <div>{{ item.product.nomb_prod }}</div>
                        <div><small>{{ item.quantity }} x</small></div>
                    </div>

                    <!-- Precio -->
                    <div style="font-weight: bold; font-size: 14px;">$ {{ item.total_price|floatformat:2 }}</div>
                </div>
                {% endfor %}

                <hr>

                <div class="d-flex justify-content-between small mb-1">
                    <strong>Subtotal:</strong>
                    <span>$ {{ cart_total|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between small mb-1">
                    <strong>IVA ({{ iva_valor }}%):</strong>
                    <span>$ {{ impuesto|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between small mb-3">
                    <strong>Total:</strong>
                    <span class="text-success fw-bold">$ {{ total_con_impuesto|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del formulario
    const formulario = document.getElementById('formulario-pago');
    const tipoDocumento = document.getElementById('tipo_documento');
    const numeroDocumento = document.getElementById('numero_documento');
    const nombreInput = document.querySelector('input[name="nombre"]');
    const telefonoInput = document.querySelector('input[name="telefono"]');
    const emailInput = document.querySelector('input[name="email"]');
    const direccionInput = document.querySelector('input[name="direccion"]');
    const ciudadInput = document.querySelector('input[name="ciudad"]');
    
    // Inicializar contadores de caracteres
    actualizarContador(nombreInput, 'nombre-counter');
    actualizarContador(emailInput, 'email-counter');
    actualizarContador(direccionInput, 'direccion-counter');
    actualizarContador(ciudadInput, 'ciudad-counter');
    actualizarContador(telefonoInput, 'telefono-counter');
    
    // Configurar eventos para contadores
    nombreInput.addEventListener('input', () => actualizarContador(nombreInput, 'nombre-counter'));
    emailInput.addEventListener('input', () => actualizarContador(emailInput, 'email-counter'));
    direccionInput.addEventListener('input', () => actualizarContador(direccionInput, 'direccion-counter'));
    ciudadInput.addEventListener('input', () => actualizarContador(ciudadInput, 'ciudad-counter'));
    telefonoInput.addEventListener('input', () => {
        actualizarContador(telefonoInput, 'telefono-counter');
        validarTelefonoEnTiempoReal();
    });
    
    // Función para actualizar contador de caracteres
    function actualizarContador(input, counterId) {
        const counter = document.getElementById(counterId);
        const maxLength = input.getAttribute('maxlength');
        const currentLength = input.value.length;
        
        counter.textContent = `${currentLength}/${maxLength}`;
        
        if (currentLength >= maxLength) {
            counter.classList.add('invalid');
        } else {
            counter.classList.remove('invalid');
        }
    }
    
    // Validación de nombre en tiempo real (solo letras)
    nombreInput.addEventListener('input', function() {
        // Eliminar cualquier caracter que no sea letra o espacio
        this.value = this.value.replace(/[^A-Za-záéíóúÁÉÍÓÚñÑ\s]/g, '');
        
        // Validar y mostrar error si es necesario
        if (/[^A-Za-záéíóúÁÉÍÓÚñÑ\s]/.test(this.value)) {
            mostrarError(nombreInput, document.getElementById('nombre-error'));
        } else {
            ocultarError(nombreInput, document.getElementById('nombre-error'));
        }
    });
    
    // Validación de teléfono en tiempo real (solo números, exactamente 10)
    telefonoInput.addEventListener('input', function() {
        // Limitar a 10 dígitos numéricos
        this.value = this.value.replace(/\D/g, '').substring(0, 10);
    });
    
    function validarTelefonoEnTiempoReal() {
        const telefonoError = document.getElementById('telefono-error');
        if (telefonoInput.value.length < 10 || !validarTelefonoEcuatoriano(telefonoInput.value)) {
            mostrarError(telefonoInput, telefonoError);
        } else {
            ocultarError(telefonoInput, telefonoError);
        }
    }
    
    // Validación de documento según tipo
    tipoDocumento.addEventListener('change', actualizarValidacionDocumento);
    numeroDocumento.addEventListener('input', validarDocumentoEnTiempoReal);
    
    // Función para actualizar validación de documento
    function actualizarValidacionDocumento() {
        const tipo = tipoDocumento.value;
        const docError = document.getElementById('documento-error');
        const docCounter = document.getElementById('documento-counter');
        
        if (tipo === 'cedula') {
            numeroDocumento.maxLength = 10;
            numeroDocumento.pattern = '\\d{10}';
            numeroDocumento.placeholder = 'Ej: 1712345678';
            docError.textContent = 'Ingrese una cédula ecuatoriana válida (10 dígitos)';
            docCounter.textContent = '0/10';
            numeroDocumento.value = numeroDocumento.value.replace(/\D/g, '').substring(0, 10);
        } else if (tipo === 'ruc') {
            numeroDocumento.maxLength = 13;
            numeroDocumento.pattern = '\\d{13}';
            numeroDocumento.placeholder = 'Ej: 1712345678001';
            docError.textContent = 'Ingrese un RUC ecuatoriano válido (13 dígitos)';
            docCounter.textContent = '0/13';
            numeroDocumento.value = numeroDocumento.value.replace(/\D/g, '').substring(0, 13);
        } else if (tipo === 'pasaporte') {
            numeroDocumento.maxLength = 20;
            numeroDocumento.pattern = '[A-Za-z0-9]{5,20}';
            numeroDocumento.placeholder = 'Ej: AB12345';
            docError.textContent = 'Ingrese un pasaporte válido (5-20 caracteres alfanuméricos)';
            docCounter.textContent = '0/20';
        }
        
        actualizarContador(numeroDocumento, 'documento-counter');
        validarDocumentoEnTiempoReal();
    }
    
    // Validación de documento en tiempo real
    function validarDocumentoEnTiempoReal() {
        const tipo = tipoDocumento.value;
        const valor = numeroDocumento.value;
        const docError = document.getElementById('documento-error');
        const docCounter = document.getElementById('documento-counter');
        
        // Actualizar contador
        actualizarContador(numeroDocumento, 'documento-counter');
        
        if (tipo === 'cedula') {
            // Solo permitir números
            numeroDocumento.value = valor.replace(/\D/g, '').substring(0, 10);
            
            if (valor.length === 10 && !validarCedulaEcuatoriana(valor)) {
                mostrarError(numeroDocumento, docError);
            } else {
                ocultarError(numeroDocumento, docError);
            }
        } else if (tipo === 'ruc') {
            // Solo permitir números
            numeroDocumento.value = valor.replace(/\D/g, '').substring(0, 13);
            
            if (valor.length === 13 && !validarRucEcuatoriano(valor)) {
                mostrarError(numeroDocumento, docError);
            } else {
                ocultarError(numeroDocumento, docError);
            }
        } else if (tipo === 'pasaporte') {
            // Permitir letras y números
            numeroDocumento.value = valor.replace(/[^A-Za-z0-9]/g, '').substring(0, 20);
            
            if ((valor.length < 5 || valor.length > 20) || !/^[A-Za-z0-9]+$/.test(valor)) {
                mostrarError(numeroDocumento, docError);
            } else {
                ocultarError(numeroDocumento, docError);
            }
        }
    }
    
    // Validación de cédula ecuatoriana
    function validarCedulaEcuatoriana(cedula) {
        if (!cedula || cedula.length !== 10 || !/^\d+$/.test(cedula)) return false;
        
        // Validar provincia (01-24)
        const provincia = parseInt(cedula.substring(0, 2));
        if (provincia < 1 || provincia > 24) return false;
        
        // Algoritmo de validación (módulo 10)
        const digitoVerificador = parseInt(cedula.charAt(9));
        let suma = 0;
        
        for (let i = 0; i < 9; i++) {
            let digito = parseInt(cedula.charAt(i));
            if (i % 2 === 0) {
                digito *= 2;
                if (digito > 9) digito -= 9;
            }
            suma += digito;
        }
        
        const verificadorCalculado = (suma % 10 === 0) ? 0 : 10 - (suma % 10);
        
        return verificadorCalculado === digitoVerificador;
    }
    
    // Validación de RUC ecuatoriano
    function validarRucEcuatoriano(ruc) {
        if (!ruc || ruc.length !== 13 || !/^\d+$/.test(ruc)) return false;
        
        // Validar provincia (01-24)
        const provincia = parseInt(ruc.substring(0, 2));
        if (provincia < 1 || provincia > 24) return false;
        
        // Validar tercer dígito (0-6 para personas naturales)
        const tercerDigito = parseInt(ruc.charAt(2));
        if (tercerDigito < 0 || tercerDigito > 6) return false;
        
        // Validar cédula base (primeros 10 dígitos)
        const cedulaBase = ruc.substring(0, 10);
        if (!validarCedulaEcuatoriana(cedulaBase)) return false;
        
        // Validar últimos tres dígitos (001 para personas naturales)
        if (tercerDigito <= 6) {
            const ultimosTres = ruc.substring(10, 13);
            if (ultimosTres !== '001') return false;
        }
        
        return true;
    }
    
    // Validación de teléfono ecuatoriano
    function validarTelefonoEcuatoriano(telefono) {
        if (!telefono || telefono.length !== 10) return false;
        
        const codigoArea = telefono.substring(0, 2);
        const codigosAreaValidos = ['09', '02', '03', '04', '05', '06', '07'];
        
        if (!codigosAreaValidos.includes(codigoArea)) return false;
        
        // Validar rangos para móviles (09)
        if (codigoArea === '09') {
            const operador = telefono.substring(1, 3);
            const operadoresValidos = ['98', '99', '96', '97', '94', '95', '93', '92'];
            if (!operadoresValidos.includes(operador)) return false;
        }
        
        return true;
    }
    
    // Mostrar mensaje de error
    function mostrarError(input, errorElement) {
        input.classList.add('is-invalid');
        errorElement.style.display = 'block';
    }
    
    // Ocultar mensaje de error
    function ocultarError(input, errorElement) {
        input.classList.remove('is-invalid');
        errorElement.style.display = 'none';
    }
    
    // Validación al enviar el formulario
    formulario.addEventListener('submit', function(e) {
        let formularioValido = true;
        
        // Validar nombre (solo letras y espacios)
        if (!/^[A-Za-záéíóúÁÉÍÓÚñÑ\s]+$/.test(nombreInput.value) || nombreInput.value.length < 2) {
            mostrarError(nombreInput, document.getElementById('nombre-error'));
            formularioValido = false;
        }
        
        // Validar documento según tipo
        const tipo = tipoDocumento.value;
        const docError = document.getElementById('documento-error');
        
        if (tipo === 'cedula') {
            if (!validarCedulaEcuatoriana(numeroDocumento.value)) {
                mostrarError(numeroDocumento, docError);
                formularioValido = false;
            }
        } else if (tipo === 'ruc') {
            if (!validarRucEcuatoriano(numeroDocumento.value)) {
                mostrarError(numeroDocumento, docError);
                formularioValido = false;
            }
        } else if (tipo === 'pasaporte') {
            if (numeroDocumento.value.length < 5 || !/^[A-Za-z0-9]+$/.test(numeroDocumento.value)) {
                mostrarError(numeroDocumento, docError);
                formularioValido = false;
            }
        }
        
        // Validar teléfono
        if (!validarTelefonoEcuatoriano(telefonoInput.value)) {
            mostrarError(telefonoInput, document.getElementById('telefono-error'));
            formularioValido = false;
        }
        
        // Validar email
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
            mostrarError(emailInput, document.getElementById('email-error'));
            formularioValido = false;
        }
        
        if (!formularioValido) {
            e.preventDefault();
            // Desplazarse al primer error
            const primerError = document.querySelector('.is-invalid');
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Inicializar validaciones
    actualizarValidacionDocumento();
    validarTelefonoEnTiempoReal();
});
</script>

{% endblock %}