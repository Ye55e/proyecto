{% extends "plantilla_admin.html" %}
{% load static %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'plantilla_cliente/css/estilos.css' %}">
<link rel="stylesheet" href="{% static 'plantilla_cliente/css/style.css' %}">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="border rounded-4 p-4 shadow-sm bg-light">
                <!-- Paso 1: Selecci칩n de tipo de movimiento -->
                <div id="paso1" {% if not request.GET.tipo %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <h3 class="text-center mb-4 fw-bold">Tipo de Movimiento</h3>
                    
                    <div class="d-flex justify-content-center gap-4">
                        <a href="?tipo=entrada" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-box-arrow-in-down"></i> Entrada
                        </a>
                        <a href="?tipo=salida" class="btn btn-warning btn-lg px-4">
                            <i class="bi bi-box-arrow-up"></i> Salida
                        </a>
                    </div>
                </div>

                <!-- Formulario de Entrada -->
                <div id="form-entrada" {% if request.GET.tipo == 'entrada' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold mb-0">Registrar Entrada</h3>
                        <a href="?tipo=" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cambiar tipo
                        </a>
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}

                    <form action="{% url 'nuevoIngreso' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="tipo_movimiento" value="Entrada">

                        <div class="mb-3">
                            <label for="producto" class="form-label fw-semibold">Producto:</label>
                            <select name="producto" class="form-select" required>
                                <option value="" disabled selected>Seleccione un producto</option>
                                {% for prod in productos %}
                                    {% if prod.inventario %}
                                        <option value="{{ prod.id_prod }}">
                                            {{ prod.nomb_prod }} - Stock: {{ prod.inventario.stock_actual }} - ${{ prod.inventario.precunit_prod }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="cantidad" class="form-label fw-semibold">Cantidad:</label>
                            <input type="number" name="cantidad" min="1" class="form-control" placeholder="Ej. 50" required>
                        </div>

                        <div class="mb-4">
                            <label for="precio" class="form-label fw-semibold">Nuevo Precio Venta:</label>
                            <input type="number" step="0.01" name="precio" min="0" class="form-control" placeholder="Ej. 15.00" required>
                            <div class="form-text">Se aplicar치 el mayor entre el precio anterior y este.</div>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="submit" class="btn btn-success px-4">
                                <i class="bi bi-check-circle"></i> Registrar Entrada
                            </button>
                            <a href="{% url 'listadoInventario' %}" class="btn btn-danger px-4">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Formulario de Salida -->
                <div id="form-salida" {% if request.GET.tipo == 'salida' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold mb-0">Registrar Salida</h3>
                        <a href="?tipo=" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cambiar tipo
                        </a>
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}

                    <form action="{% url 'nuevoIngreso' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="tipo_movimiento" value="Salida">

                        <div class="mb-3">
                            <label for="producto" class="form-label fw-semibold">Producto:</label>
                            <select name="producto" id="producto-salida" class="form-select" required>
                                <option value="" disabled selected>Seleccione un producto</option>
                                {% for prod in productos %}
                                    {% if prod.inventario %}
                                        <option value="{{ prod.id_prod }}" data-stock="{{ prod.inventario.stock_actual }}">
                                            {{ prod.nomb_prod }} - Stock: {{ prod.inventario.stock_actual }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="cantidad" class="form-label fw-semibold">Cantidad:</label>
                            <input type="number" name="cantidad" min="1" class="form-control" placeholder="Ej. 5" required>
                            <small class="text-muted" id="max-stock">Stock disponible: <span id="stock-disponible">0</span></small>
                        </div>

                        <div class="mb-4">
                            <label for="observacion" class="form-label fw-semibold">Motivo de Salida:</label>
                            <textarea name="observacion" class="form-control" placeholder="Ej. Venta a cliente, da침ado, etc." required></textarea>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="submit" class="btn btn-warning px-4">
                                <i class="bi bi-check-circle"></i> Registrar Salida
                            </button>
                            <a href="{% url 'listadoInventario' %}" class="btn btn-danger px-4">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar stock disponible para salidas
    const productoSelect = document.getElementById('producto-salida');
    if (productoSelect) {
        productoSelect.addEventListener('change', function() {
            const stock = this.selectedOptions[0]?.dataset.stock || 0;
            document.getElementById('stock-disponible').textContent = stock;
            const cantidadInput = document.querySelector('#form-salida input[name="cantidad"]');
            cantidadInput.max = stock;
            cantidadInput.placeholder = 'M치ximo: ' + stock;
        });
        
        // Inicializar con el primer producto
        if (productoSelect.options.length > 1) {
            productoSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}