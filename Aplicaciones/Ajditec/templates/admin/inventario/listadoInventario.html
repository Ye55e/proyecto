{% extends "plantilla_admin.html" %}
{% load static %}
{% block contenido %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="text-center mb-3">
        <h3>INVENTARIO AJ DITEC</h3>
    </div>

    <div class="d-flex justify-content-end mb-4">
        <div class="btn-group">
            <a href="/nuevoInventario/" class="btn btn-success me-2">
                <i class="bi bi-plus-circle me-2"></i>Nuevo Inventario
            </a>
            <a href="{% url 'nuevoIngreso' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Nuevo Movimiento
            </a>
        </div>
    </div>

    {% if productos_bajos_stock %}
        <div class="alert alert-danger small">
            <strong>¡Alerta!</strong> Algunos productos tienen un stock bajo. Por favor, verifique.
        </div>
    {% endif %}

    {% if inventarios %}
    <div class="card shadow">
      <div class="card-body">
        <table id="tbl_inventario" class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Cod Producto</th>
              <th>Producto</th>
              <th>Precio Compra</th>
              <th>Precio Venta</th>
              <th>Stock Actual</th>
              <th>Fecha Creación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in inventarios %}
            <tr {% if inv.stock_actual <= 3 %} class="table-danger" {% endif %}>
              <td>{{ inv.id_inve }}</td>
              <td>PDT{{ inv.producto.id_prod }}</td>
              <td>{{ inv.producto.nomb_prod }}</td>
              <td>${{ inv.producto.precio_compra|floatformat:2 }}</td>

              <!-- Columna editable -->
              <td class="precio-venta" data-id="{{ inv.id_inve }}">
                <span class="precio-texto">${{ inv.precunit_prod|floatformat:2 }}</span>
                <input type="number" step="0.01" class="form-control form-control-sm precio-input d-none"
                       value="{{ inv.precunit_prod }}">
              </td>

              <td>{{ inv.stock_actual }}</td>
              <td>{{ inv.fechacrea_inve|date:"d/m/Y" }}</td>
              <td>
                <a href="#modalHistorial{{ inv.id_inve }}" class="btn btn-outline-info btn-sm"
                    data-bs-toggle="modal" data-bs-target="#modalHistorial{{ inv.id_inve }}"
                    title="Ver Movimientos">
                        <i class="bi bi-clock-history"></i>
                    </a>


                <!-- Botones -->
                <button class="btn btn-warning btn-sm btn-editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-success btn-sm btn-guardar d-none">
                    <i class="bi bi-save"></i>
                </button>
                <button class="btn btn-secondary btn-sm btn-cancelar d-none">
                    <i class="bi bi-x"></i>
                </button>

                <a onclick="return confirm('¿Está seguro de eliminar permanentemente?')"
                   href="/eliminarInventario/{{ inv.id_inve }}" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i>
                </a>

                <!-- Modal historial -->
                <div class="modal fade" id="modalHistorial{{ inv.id_inve }}" tabindex="-1" aria-labelledby="modalHistorialLabel{{ inv.id_inve }}" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-dark text-white">
                                <h5 class="modal-title" id="modalHistorialLabel{{ inv.id_inve }}">
                                    <i class="bi bi-clock-history me-2"></i>Historial de Movimientos - {{ inv.producto.nomb_prod }}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="table-responsive" style="max-height: 70vh;">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="sticky-top" style="top: -1px;">
                                            <tr class="table-dark">
                                                <th>Tipo</th>
                                                <th>Cantidad</th>
                                                <th>Precio Anterior</th>
                                                <th>Precio Nuevo</th>
                                                <th>Precio Venta</th>
                                                <th>Fecha</th>
                                                <th>Observación</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for mov in inv.producto.movimientos.all %}
                                            <tr>
                                                <td>
                                                    <span class="badge 
                                                        {% if mov.tipo == 'INGRESO' %}bg-success
                                                        {% elif mov.tipo == 'EGRESO' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ mov.tipo }}
                                                    </span>
                                                </td>
                                                <td>{{ mov.cantidad }}</td>
                                                <td>${{ mov.precio_anterior|default:"-"|floatformat:2 }}</td>
                                                <td>${{ mov.precio_uni|default:"-"|floatformat:2 }}</td>
                                                <td>${{ mov.precio_venta|default:"-"|floatformat:2 }}</td>
                                                <td>{{ mov.fecha|date:"d/m/Y H:i" }}</td>
                                                <td>{{ mov.observacion|default:"-" }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center py-4">
                                                    <i class="bi bi-info-circle fs-4"></i>
                                                    <p class="mb-0">No hay movimientos registrados</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
             </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i> No hay productos en el inventario.
        </div>
    {% endif %}

{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {
      if ($('#tbl_inventario').length && $('#tbl_inventario tbody tr').length > 0) {
          $('#tbl_inventario').DataTable({ 
              scrollX: true,
              responsive: true,
              language: { url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/es-ES.json' },
              dom: 'Bfrtip',
              buttons: [
                  { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel"></i> Excel', className: 'btn btn-success me-2' },
                  { extend: 'pdfHtml5', text: '<i class="bi bi-file-earmark-pdf"></i> PDF', className: 'btn btn-danger me-2' },
                  { extend: 'print', text: '<i class="bi bi-printer"></i> Imprimir', className: 'btn btn-primary' }
              ]
          });
      }

      // Modo edición
    $(".btn-editar").off("click").on("click", function(){
    const fila = $(this).closest("tr");
    const tdPrecio = fila.find(".precio-venta");
    const spanPrecio = tdPrecio.find(".precio-texto");
    const inputPrecio = tdPrecio.find(".precio-input");

    // Tomamos SIEMPRE el valor del span y lo limpiamos
    let valorActual = spanPrecio.text().replace(/[^0-9.,]/g, "").replace(",", ".");

    // Si por alguna razón el span está vacío, usamos el valor actual del input
    if (valorActual === "" || isNaN(valorActual)) {
        valorActual = inputPrecio.val() || "0.00";
    }

    // Asignamos el valor al input con formato de 2 decimales
    inputPrecio.val(parseFloat(valorActual).toFixed(2));

    // Mostramos el input y ocultamos el texto
    spanPrecio.addClass("d-none");
    inputPrecio.removeClass("d-none").focus();

    fila.find(".btn-editar").addClass("d-none");
    fila.find(".btn-guardar, .btn-cancelar").removeClass("d-none");
});


      // Cancelar
      $(".btn-cancelar").click(function(){
          const fila = $(this).closest("tr");
          const tdPrecio = fila.find(".precio-venta");

          tdPrecio.find(".precio-input").addClass("d-none");
          tdPrecio.find(".precio-texto").removeClass("d-none");

          fila.find(".btn-editar").removeClass("d-none");
          fila.find(".btn-guardar, .btn-cancelar").addClass("d-none");
      });

      // Guardar
      $(".btn-guardar").click(function(){
          const fila = $(this).closest("tr");
          const tdPrecio = fila.find(".precio-venta");
          const inputPrecio = tdPrecio.find(".precio-input");
          const nuevo_precio = inputPrecio.val();
          const id_inve = tdPrecio.data("id");

          $.ajax({
              url: "{% url 'actualizar_precio_venta' %}",
              method: "POST",
              data: {
                  'id_inve': id_inve,
                  'precio': nuevo_precio,
                  'csrfmiddlewaretoken': '{{ csrf_token }}'
              },
              success: function(response){
                  if(response.status === 'ok'){
                      tdPrecio.find(".precio-texto").text("$" + parseFloat(nuevo_precio).toFixed(2));
                      inputPrecio.addClass("d-none");
                      tdPrecio.find(".precio-texto").removeClass("d-none");

                      fila.find(".btn-editar").removeClass("d-none");
                      fila.find(".btn-guardar, .btn-cancelar").addClass("d-none");
                  } else {
                      alert("Error: " + response.message);
                  }
              },
              error: function(){
                  alert("No se pudo actualizar el precio.");
              }
          });
      });
  });
</script>

<style>
    .table { width: 100% !important; table-layout: auto; }
    .card-body { padding: 0; overflow-x: auto; }
    #tbl_inventario_wrapper { overflow-x: auto; }
    div.dt-buttons { margin-bottom: 10px; }
    .dataTables_scrollHeadInner, .dataTables_scrollBody { width: 100% !important; }
    div.dt-buttons .btn { margin-right: 10px; }
    .modal-body { max-height: 500px; overflow-y: auto; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
</style>
{% endblock %}
